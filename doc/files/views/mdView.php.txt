<?php 
/**
 * OpenId szolgáltatás magyarorszag.hu ügyfélkapu használatával
 * @package uklogin
 * @author Fogler Tibor
 */

include_once './views/common.php';

/**
 * MdView 
 * @author utopszkij
 */
class MdView extends CommonView {
    
    /**
     * strong feldolgozása
     * @param string $l
     */
    protected function processStrong(string &$l) {
        $i = strpos($l, '**');
        if ($i !== false) {
            $l = substr($l, 0, $i).'<strong>'.substr($l,$i+2,1000);
        }
        $i = strpos($l, '**');
        if ($i > 0) {
            $l = substr($l, 0, $i).'</strong>'.substr($l,$i+2,1000);
        }
    }
    
    /**
     * URL feldolgozása
     * @param string $line
     */
    protected function processUri(string &$line) {
        $i = strpos($line,'[');
        $j = strpos($line,']');
        $k = strpos($line,'(');
        $l = strpos($line,')');
        $line = substr($line,0,$i).
        '<a href="'.substr($line,$k+1, $l-$k-1).'">'.
        substr($line,$i+1, $j-$i-1).
        '</a>'.
        substr($line,$l+1,400);
    }
    
    /**
     * Megjelenítés 
     * @param Params $p
     * @param string $mdName
     */
    public function mdShow(Params $p, string $mdName) {
        $this->echoHtmlHead($p);
        ?>
        <style type="text/css">
        h1,h2,h3,h4,h5 {margin-top:15px;}
        </style>
        <body>
       	<?php $this->echoNavbar($p); ?>
		<div style="padding:0px 5% 5% 5%; text-align:left">
			<div class="page-icon">	
				<em class="fa fa-book"></em>
			</div>
			<?php 
                $lines = file($mdName);
                $inUl = false;
                $inUl2 = false;
                $inCode = false;
                foreach ($lines as $line) {
                    $line = str_replace('ADATKEZELO_SIGN',config('ADATKEZELO_SIGN'),$line);
                    $line = str_replace('ADATFELDOLGOZO',config('ADATFELDOLGOZO'),$line);
                    $line = str_replace('ADATKEZELO',config('ADATKEZELO'),$line);
                    
                    if (strpos(' '.$line,'  - ') == 1) {
                        if (!$inUl2) {
                            $inUl2 = true;
                            $line = '<ul style="list-style:none"><li><ul><li>'.substr($line,3,1800).'</li>';
                        } else {
                            $line = '<li>'.substr($line,3,1800).'</li>';
                        }
                    } else {
                        if ($inUl2) {
                            echo '</ul></li></ul>';
                        }
                        $inUl2 = false;
                    }
                    
                    if (strpos(' '.$line,'- ') == 1) {
                        if (!$inUl) {
                            $inUl = true;
                            $line = '<ul><li>'.substr($line,2,1800).'</li>';
                        } else {
                            $line = '<li>'.substr($line,2,1800).'</li>';
                        }
                    } else {
                        if ($inUl) {
                            echo '</ul>';
                            $inUl = true;
                        }
                        $inUl = false;
                    }
                    
                    if (strpos(' '.$line,'```') == 1) {
                        $line = substr($line,3,1800);
                        if (!$inCode) {
                            $inCode = true;
                            echo '<pre><code>';
                        } else {
                            echo '</code></pre>';
                            $inCode = false;
                        }
                    }
                    
                    if (strpos(' '.$line,'# ') == 1) {
                        $line = '<h1>'.substr($line,1,1800).'</h1>';
                    }
                    if (strpos(' '.$line,'## ') == 1) {
                        $line = '<h2>'.substr($line,2,1800).'</h2>';
                    }
                    if (strpos(' '.$line,'### ') == 1) {
                        $line = '<h3>'.substr($line,3,1800).'</h3>';
                    }
                    if (strpos(' '.$line,'#### ') == 1) {
                        $line = '<h4>'.substr($line,4,1800).'</h4>';
                    }
                    if (trim($line) == '') {
                        echo '<br />';
                    }
                    $this->processStrong($line);
                    $this->processStrong($line);
                    $this->processStrong($line);
                    $this->processStrong($line);
                    if (strpos($line, '[') !== false) {
                        $this->processUri($line);
                    }
                    if ($inCode) {
                      $line = str_replace('<','&lt;',$line);
                      $line = str_replace('>','&gt;',$line);
                 	  }
                    echo $line;
                }
			?>
       	</div>
       	<?php $this->echoFooter($p); ?>
       	</body>
       	</html>
        <?php 	
    }
}
?>
